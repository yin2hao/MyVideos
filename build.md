# MyVideos 项目文档

## 项目概述

MyVideos 是一个专为个人使用的 Android 应用程序，主要功能是加密视频文件并上传到用户指定的云存储服务器，同时支持在线播放加密视频。

## 关键功能点

### 核心功能
- **视频加密上传**：支持加密算法对视频文件进行加密后上传
- **多云存储支持**：支持 WebDAV、FTP/FTPS、S3 兼容存储等多种云存储方式
- **在线播放**：通过本地代理服务器实现边下边播，支持加密视频的流式播放
- **视频管理**：本地视频列表展示，支持视频信息查看和播放

### 技术架构
- **前端界面**：现代化 Material Design 3 界面
- **视频播放**：集成 ExoPlayer，支持多种视频格式
- **网络通信**：使用 OkHttp 处理 HTTP 请求，Apache Commons Net 处理 FTP
- **数据存储**：使用 DataStore 存储应用设置和配置
- **加密解密**：自定义加密管理器
- **本地代理**：使用 NanoHTTPD 实现本地 HTTP 代理服务器，用于视频解密播放

## 使用逻辑

### 应用流程
1. **首次使用配置**
   - 打开应用进入设置页面
   - 配置云存储服务器信息（WebDAV/FTP/S3）
   - 设置主密码（用于视频加密）
   - 测试连接确保配置正确

2. **视频上传流程**
   - 在上传页面选择本地视频文件
   - 输入视频标题和描述信息
   - 点击上传按钮，应用将：
     - 使用主密码生成加密密钥
     - 对视频文件进行 AES-256-GCM 加密
     - 将加密文件上传到配置的云存储
     - 保存视频元数据到本地存储

3. **视频播放流程**
   - 在视频列表页面选择要播放的视频
   - 应用启动本地代理服务器（端口 8888）
   - ExoPlayer 请求视频数据时：
     - 代理服务器从云存储下载加密分块
     - 实时解密后返回给播放器
     - 实现边下边播功能

### 界面结构
- **视频页面**：显示已上传视频列表，支持点击播放
- **上传页面**：视频文件选择、元数据输入、上传进度显示
- **设置页面**：云存储配置、主密码设置、应用偏好设置

## 打包方式

### 签名配置
发布版本 APK 需要数字签名，签名信息通过 Gradle 属性传递：
- `versionName`：版本名称（如 "1.0.0"）
- `versionCode`：版本代码（整数，用于版本比较）

## 构建方式

### 构建配置
- **编译 SDK 版本**：35 (Android 15)
- **目标 SDK 版本**：35
- **最小 SDK 版本**：26 (Android 8.0)
- **Java 版本**：17
- **Kotlin 版本**：2.0.21

### 依赖管理
项目使用 Gradle 版本目录 (libs.versions.toml) 集中管理依赖版本，主要依赖包括：
- **UI 框架**：Compose BOM 2024.12.01
- **网络**：OkHttp 4.12.0
- **视频播放**：Media3 ExoPlayer 1.5.1
- **图像加载**：Coil 2.7.0
- **加密**：Android 内置 JCE
- **数据存储**：DataStore Preferences 1.1.1

## 版本规则

### 版本号格式
- **版本名称 (versionName)**：遵循语义化版本格式，如 `1.0.0`、`1.1.0-beta`
- **版本代码 (versionCode)**：整数值，用于 Google Play 等平台版本比较

### 版本管理策略
1. **开发阶段**：使用默认值 `versionName = "1.0"`，`versionCode = 1`
2. **发布版本**：通过命令行参数传递版本信息
3. **CI/CD 版本**：GitHub Actions 根据 Git Tag 自动生成版本号

### GitHub Actions 版本规则
- **触发条件**：推送 Git Tag（格式：`v*`，如 `v1.0.0`）
- **versionName**：从 Tag 名称提取（如 `v1.0.0` → `1.0.0`）
- **versionCode**：使用 Git 提交计数（`git rev-list --count HEAD`）
- **预发布标识**：Tag 包含连字符（如 `v1.0.0-beta`）标记为预发布

## GitHub Actions 工作流规则

### 工作流文件
build-release.yml

### 触发条件
- **Tag 推送**：当推送以 `v` 开头的 Tag 时触发
- **手动触发**：支持 `workflow_dispatch` 手动运行

### 构建流程
1. **代码检出**：获取完整代码历史
2. **JDK 设置**：安装 JDK 17，启用 Gradle 缓存
3. **Android SDK 设置**：安装构建工具 35.0.0
4. **版本提取**：
   - 从 Tag 名称提取 versionName
   - 从 Git 提交计数计算 versionCode
5. **密钥库解码**：从 GitHub Secrets 解码签名密钥库
6. **构建 APK**：使用 Gradle 构建未签名发布 APK
7. **APK 对齐和签名**：
   - 使用 zipalign 对齐 APK
   - 使用 apksigner 进行数字签名
   - 验证签名完整性
8. **文件重命名**：根据 Tag 生成 APK 文件名
9. **校验和生成**：生成 SHA256 校验和文件
10. **安全清理**：清理临时密钥和敏感文件

### 发布策略
- **正式发布**：Tag 不含连字符时创建 GitHub Release
- **预发布**：Tag 含连字符时上传为 Artifacts
- **文件包含**：APK 文件和 SHA256 校验和文件

### 所需 Secrets
- `SIGNING_KEY`：Base64 编码的密钥库文件
- `KEY_ALIAS`：密钥别名
- `KEY_STORE_PASSWORD`：密钥库密码
- `KEY_PASSWORD`：密钥密码

### 缓存策略
- Gradle 包缓存：基于 Gradle 文件哈希
- 构建产物：自动缓存以加速后续构建

## 安全考虑

### 加密机制
- **算法**：AES-256-GCM，提供机密性和完整性保护
- **密钥管理**：从用户主密码派生加密密钥
- **随机性**：使用 SecureRandom 生成 IV 和盐值

### 网络安全
- **HTTPS**：优先使用加密连接
- **证书验证**：验证服务器证书有效性
- **敏感数据**：密码等敏感信息不存储在日志中

### 应用安全
- **权限控制**：最小权限原则，只请求必要权限
- **代码混淆**：发布版本启用 ProGuard 代码混淆
- **签名验证**：确保 APK 完整性和来源可靠性

## 扩展性

### 云存储扩展
项目采用统一接口设计（`CloudStorageClient`），支持轻松添加新的云存储提供商：
1. 实现 `CloudStorageClient` 接口
2. 在 `CloudStorageClientFactory` 中注册
3. 更新设置界面添加配置选项

### 功能扩展
- **视频格式支持**：可扩展支持更多视频编解码器
- **播放功能**：可添加字幕、倍速播放等功能
- **离线播放**：可实现视频本地缓存功能

## 部署和分发

### 应用分发
- **Google Play**：支持标准 APK 上传
- **直接下载**：通过 GitHub Release 分发
- **私有分发**：支持企业内部分发

### 更新机制
- **手动更新**：用户从 Release 页面下载新版本
- **自动检查**：可扩展实现版本更新检查功能

## 故障排除

### 常见问题
1. **连接失败**：检查网络配置和服务器设置
2. **播放失败**：确认主密码正确，检查本地代理服务
3. **上传失败**：检查存储空间和网络连接
4. **签名失败**：确认密钥库文件和密码正确

### 日志调试
应用使用 Android 日志系统，Tag 为类名，可通过 `adb logcat` 查看调试信息。